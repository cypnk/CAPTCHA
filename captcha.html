<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Simple, client-side, CAPTCHA test</title>
<style>
body {
	font: 400 1rem sans-serif;
	line-height: 1.6;
}

input {
	line-height: inherit;
	padding: 0.2rem 0.5rem;
}

button, input:is([type="submit"], [type="button"]) {
	cursor: pointer;
	padding: 0.2rem 1rem;
}

canvas {
	vertical-align: middle;
}

#captcha-img {
	cursor: pointer;
}

* + p {
	margin-top: 2rem;
}
</style>
</head>
<body>
<form method="post" action="/">
<input type="hidden" id="nonce" name="nonce" value="server-side-nonce"> <!-- Sent by the server -->
<input type="hidden" id="cnonce" name="cnonce" value=""> <!-- Created by the script -->

<!-- Create your CAPTCHA canvas at a desired size that covers all characters -->
<p><canvas id="captcha-img" width="150" height="50" 
	title="Click to load a new CAPTCHA"></canvas><br />
Click image to load a new CAPTCHA</p> 

<p><input type="text" id="captcha" name="captcha" required></p>
<p><input type="submit" value="Post"></p>
</form>


<script type="text/javascript">
( function () {
	// Crypto API required
	if ( !window.crypto || !window.crypto.subtle ) {
		return;
	}
	
	// Captcha image canvas
	const canvas	= document.getElementById( 'captcha-img' );
	if ( !canvas ) { return; }	// Required
	
	// Generated by server
	var nonce	= document.getElementById( 'nonce' );
	if ( !nonce ) { return; }	// Required
	
	// Generated by client
	var cnonce	= document.getElementById( 'cnonce' );
	if ( !cnonce ) { return; }	// Required
	
	// Create random data for nonce
	async function genNonce() {
		const data	= new Uint8Array( 32 );
		crypto.getRandomValues( data );
		return data;
	}
	
	// Create hash digest from given text
	async function digest( txt ) {
		const enc	= new TextEncoder();
		const data	= enc.encode( txt );
		const buf	= await crypto.subtle.digest( 'SHA-256', data );
		
		const hex	= 
		Array.from( new Uint8Array( buf ) )
			.map( byte => byte.toString( 16 )
			.padStart( 2, '0' ) )
			.join( '' );
		return hex;
	}
	
	// Add background graidents
	function addGradients( grad ) {
		for ( let i = 0; i < 10; i++ ) {
			grad.addColorStop( 
				i * 0.1, 
				`rgb(
					${ Math.floor( 255 - Math.random() * 80 ) },
					${ Math.floor( 255 - Math.random() * 80 ) },
					${ Math.floor( 255 - Math.random() * 80 ) }, 
					1
				)`
			);
		}
	}
	
	// Generate captcha image on canvas
	function captcha( txt ) {
		const x		= 20;
		const y		= 30;
		
		const ctx	= canvas.getContext( '2d' );
		
		// Background gradient
		const grad	= 
		ctx.createLinearGradient( 0, 0, canvas.width, canvas.height );
		
		// Add gradients
		addGradients( grad );
		
		ctx.fillStyle	= grad;
		ctx.fillRect( 0, 0, canvas.width, canvas.height );
		
		// Widen character range, remove confusing ones
		txt		= 
		window.btoa( txt )
			.replace( /[0oO1li=\/]/g, '' )
			.substring( 0, 8 );
		
		for ( let i = 0; i < txt.length; i++ ) {
			// Random rotation angle +/- 45
			const a	= ( Math.random() - 0.5 ) * ( Math.PI / 4 );
			
			// Random font size
			const f	= Math.floor( 30 - ( Math.random() * 12 ) );
			
			ctx.save();
			ctx.font	= `${f}px monospace`;
			
			// Random color
			ctx.fillStyle = `rgb(
				${ Math.floor( Math.random() * 170 ) },
				${ Math.floor( Math.random() * 170 ) },
				${ Math.floor( Math.random() * 170 ) },
				0.8
			)`;
			
			// Random x/y position
			ctx.translate( 
				x + ( ( Math.random() - 0.5 ) * 2 ) + i * 15, 
				y + ( ( Math.random() - 0.2 ) * 12 )
			);
			
			// Random skew
			ctx.transform( 
				1, Math.random() - 0.5, Math.random() - 0.5, 
				1, Math.random() - 0.5, 0 
			);
			
			// Random blur
			ctx.filter	= 
			`blur(${ 0.3 - Math.floor( Math.random() * 0.01 ) }px)`;
			
			// Rotate
			ctx.rotate( a );
			
			// Add text
			ctx.fillText( txt[i], 0, 0 );
			
			// Return to base level before next character
			ctx.restore();
		}
	}
	
	// Run CAPTCHA generation
	function generate() {
		genNonce().then( n => {
			digest( n ).then( hash => {
				cnonce.value = hash;
				digest( nonce.value + hash ).then( cap => {
					captcha( cap );
				} );
			} );
		});
	}
	
	// Run on load
	window.addEventListener( 'load', ( e ) => {
		generate();
	} );
	
	// Run on CAPTCHA click
	canvas.addEventListener( 'click', ( e ) => {
		generate();
	} );
} )();
</script>
</body>
</html>
